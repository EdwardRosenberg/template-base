name: CI

on:
  workflow_call:
    inputs:
      # Backend configuration
      backend-enabled:
        description: 'Enable backend job'
        type: boolean
        default: true
      backend-tech-stack:
        description: 'Backend technology stack (java, python, node, or custom)'
        type: string
        default: 'custom'
      backend-os-matrix:
        description: 'OS matrix for backend (JSON array, e.g., ["ubuntu-latest"])'
        type: string
        default: '["ubuntu-latest"]'
      backend-setup-command:
        description: 'Backend setup command (runs before build)'
        type: string
        default: ''
      backend-build-command:
        description: 'Backend build command'
        type: string
        default: 'echo "Add backend build steps here"'
      backend-test-command:
        description: 'Backend test command'
        type: string
        default: ''
      java-version:
        description: 'Java version (if backend-tech-stack is java)'
        type: string
        default: '21'
      java-distribution:
        description: 'Java distribution (if backend-tech-stack is java)'
        type: string
        default: 'temurin'
      python-version:
        description: 'Python version (if backend-tech-stack is python)'
        type: string
        default: '3.11'
      backend-node-version:
        description: 'Node.js version (if backend-tech-stack is node)'
        type: string
        default: '20'

      # Frontend configuration
      frontend-enabled:
        description: 'Enable frontend job'
        type: boolean
        default: true
      frontend-tech-stack:
        description: 'Frontend technology stack (node or custom)'
        type: string
        default: 'custom'
      frontend-os-matrix:
        description: 'OS matrix for frontend (JSON array, e.g., ["ubuntu-latest"])'
        type: string
        default: '["ubuntu-latest"]'
      frontend-node-version:
        description: 'Node.js version (if frontend-tech-stack is node)'
        type: string
        default: '20'
      frontend-package-manager:
        description: 'Package manager for Node.js (npm, yarn, pnpm)'
        type: string
        default: 'npm'
      frontend-setup-command:
        description: 'Frontend setup command (runs before build)'
        type: string
        default: ''
      frontend-build-command:
        description: 'Frontend build command'
        type: string
        default: 'echo "Add frontend build steps here"'
      frontend-test-command:
        description: 'Frontend test command'
        type: string
        default: ''
      frontend-lint-command:
        description: 'Frontend lint command'
        type: string
        default: ''

      # CI Success job configuration
      ci-success-enabled:
        description: 'Enable CI success summary job'
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  backend:
    name: Backend Build & Test
    if: ${{ inputs.backend-enabled }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true
      matrix:
        os: ${{ fromJSON(inputs.backend-os-matrix || '["ubuntu-latest"]') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Java/Maven setup
      - name: Set up JDK
        if: ${{ inputs.backend-tech-stack == 'java' }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version || '21' }}
          distribution: ${{ inputs.java-distribution || 'temurin' }}
          cache: 'maven'

      # Python setup
      - name: Set up Python
        if: ${{ inputs.backend-tech-stack == 'python' }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version || '3.11' }}
          cache: 'pip'

      # Node.js setup (for backend)
      - name: Set up Node.js
        if: ${{ inputs.backend-tech-stack == 'node' }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ inputs.backend-node-version || '20' }}
          cache: 'npm'

      # Custom setup command
      - name: Run custom setup
        if: ${{ inputs.backend-setup-command != '' }}
        run: ${{ inputs.backend-setup-command }}

      # Build step
      - name: Build
        run: ${{ inputs.backend-build-command || 'echo "Add backend build steps here"' }}

      # Test step
      - name: Run tests
        if: ${{ inputs.backend-test-command != '' }}
        run: ${{ inputs.backend-test-command }}

  frontend:
    name: Frontend Build & Test
    if: ${{ inputs.frontend-enabled }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true
      matrix:
        os: ${{ fromJSON(inputs.frontend-os-matrix || '["ubuntu-latest"]') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Node.js setup
      - name: Set up Node.js
        if: ${{ inputs.frontend-tech-stack == 'node' }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ inputs.frontend-node-version || '20' }}
          cache: ${{ inputs.frontend-package-manager || 'npm' }}

      # Custom setup command
      - name: Run custom setup
        if: ${{ inputs.frontend-setup-command != '' }}
        run: ${{ inputs.frontend-setup-command }}

      # Lint step
      - name: Run linting
        if: ${{ inputs.frontend-lint-command != '' }}
        run: ${{ inputs.frontend-lint-command }}

      # Build step
      - name: Build
        run: ${{ inputs.frontend-build-command || 'echo "Add frontend build steps here"' }}

      # Test step
      - name: Run tests
        if: ${{ inputs.frontend-test-command != '' }}
        run: ${{ inputs.frontend-test-command }}

  # Optional: Summary job that depends on all other jobs (can be removed if not using branch protection rules)
  # This is useful for branch protection rules
  ci-success:
    name: CI Success
    if: ${{ always() && inputs.ci-success-enabled }}
    needs: [backend, frontend]
    runs-on: ubuntu-latest
    steps:
      - name: Check job results
        run: |
          backend_result="${{ needs.backend.result }}"
          frontend_result="${{ needs.frontend.result }}"

          # Skip check if job was skipped due to being disabled
          if [ "$backend_result" != "skipped" ]; then
            if [ "$backend_result" = "failure" ] || [ "$backend_result" = "cancelled" ]; then
              echo "Backend job failed"
              exit 1
            fi
          fi

          if [ "$frontend_result" != "skipped" ]; then
            if [ "$frontend_result" = "failure" ] || [ "$frontend_result" = "cancelled" ]; then
              echo "Frontend job failed"
              exit 1
            fi
          fi

          echo "All CI jobs passed successfully"
